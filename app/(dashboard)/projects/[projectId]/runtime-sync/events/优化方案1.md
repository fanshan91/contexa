# Runtime Sync 采集会话页面 UX 优化方案

## 背景

`/runtime-sync/session` 是项目核心功能页面，用于开发人员在采集会话中管理 SDK 上报的词条数据，建立词条与页面/模块的关联。当前交互存在以下已知问题和可优化空间。

---

## 一、用户反馈的两个问题分析

### 问题 1：路由创建阻断关联操作

**现状**：事件列表点击「关联页面/模块」→ 打开 `RuntimeSyncDrawer` → 若该路由无对应 Page，抽屉进入 `diff.page === null` 分支 → 整个 diff 表格被模糊遮罩 + `pointer-events-none` 覆盖，文字提示「请先创建页面」→ 必须先创建页面后才能进行任何操作。

> **⚠️ 关键代码**：`runtime-sync-drawer.tsx` L459-L469 中的遮罩完全阻断了用户检视词条内容的能力，体验上是「强阻断」。

**优化方向**：路由（Page）创建与词条关联解耦
- 没有 Page 时仍允许用户**查看** diff 数据（去掉 blur/遮罩）
- 将「创建页面」从阻断性警告改为顶部**行内提示 + 快捷创建**，创建完成后自动刷新 picker 列表
- 或者更激进地：在每行的 `ContextNodePicker` 中内联提供「新建页面」入口，用户可在选择目标时直接创建

---

### 问题 2：事件列表与路由概览共用同一个抽屉，维度不匹配

**现状**：
- 事件列表每行是**单个词条**（route + key），点击「关联页面/模块」打开的是**该 route 下所有 diff items** 的批量处理抽屉
- 路由概览每行是**一个路由**，点击「查看/处理」打开的也是同一个抽屉
- 两者操作入口不同，但抽屉内容完全相同：均展示整个路由的 diff 并要求批量处理

> **❗ 核心矛盾**：事件列表场景下用户期望**针对单条词条操作**（查看状态、快速绑定、忽略等），但实际打开的是路由级批量抽屉，信息过载且操作目标不明确。

**优化方向**：区分两种操作维度

| 入口 | 操作目标 | 理想交互 |
|------|----------|----------|
| 事件列表行级操作 | 单条词条 | **内联操作**或轻量弹出（Popover），直接完成绑定/忽略 |
| 路由概览行级操作 | 整个路由 | 保留当前抽屉，批量处理该路由下所有 diff |

---

## 二、额外发现的可优化项

### 优化 3：事件列表缺少行级内联操作

**现状**：事件列表每行只有一个「关联页面/模块」按钮，所有操作都必须打开抽屉。

**建议**：为事件列表增加**行级快捷操作**
- 已关联的词条：显示当前归属（Page/Module 名称），点击可切换
- 未关联/新增的词条：直接在行内提供 `ContextNodePicker` 下拉选择目标
- 提供「忽略」快捷按钮
- 这些操作直接调用 `upsertRuntimeSessionDraftOpAction` 保存草稿，不再需要打开重型抽屉

> **💡 收益**：开发人员可以在事件列表中**流水线式**地逐条处理词条，效率远高于反复打开/关闭抽屉。

### 优化 4：attentionReason 提示可转化为快速操作入口

**现状**：`runtime-events-client.tsx` L248-L257 中 `attentionReason` 仅显示文字标签（缺失页面/未收录/未绑定/文案变更），是纯展示。

**建议**：将提示与操作联动
- `missing_page`："缺失页面" 旁增加「创建」快捷入口
- `unregistered`："未收录" 旁增加「收录并绑定」快捷入口
- `unbound`："未绑定" 旁直接展开 Picker
- `text_changed`："文案变更" 旁增加「查看差异」用 Popover 展示旧→新对比

### 优化 5：筛选器交互优化

**现状**：
- 筛选条件变化后 (`onlyDiff`/`routeFilter`) 自动触发请求，但搜索框需手动按回车或点击搜索按钮，体验不一致
- 路由过滤器 `Select` 宽度固定 260px，路由名称可能被截断
- 没有筛选结果数量统计（如"符合 1 条筛选 / 共 50 条"）

**建议**：
- 搜索框增加防抖自动搜索（300ms debounce），消除回车依赖
- 路由过滤下拉菜单改为可搜索 + 显示各路由词条数的 Combobox
- 在筛选栏右侧显示当前过滤条件生效后的匹配数（帮助用户判断筛选效果）

### 优化 6：双视图切换缺少数据概览引导

**现状**：「事件列表」与「路由概览」作为两个 Button 切换，没有附带概览数据。

**建议**：按钮文字中附加概览数字，如：
- `事件列表 (47)` / `路由概览 (5)` 
- 帮助用户快速判断该看哪个视图

### 优化 7：分页交互偏弱

**现状**：分页控件只有「上一页/下一页」和页码，没有 PageSize 切换和跳页能力。

**建议**：
- 增加 PageSize 选择（20/50/100），减少翻页次数
- 对于词条数不多的项目，默认显示更多（如 50 条），减少分页操作

---

## 三、优化优先级建议

| 优先级 | 优化项 | 改动范围 | 收益 |
|--------|--------|----------|------|
| **P0** | 问题 2：事件列表行级内联操作 | `runtime-events-client.tsx` columns 定义 | 消除最大痛点：每条词条不再需要打开抽屉 |
| **P0** | 问题 1：路由创建不阻断 | `runtime-sync-drawer.tsx` | 去除强阻断，允许先查看数据再创建 |
| **P1** | 优化 4：attention 标签可操作化 | `runtime-events-client.tsx` columns | 把提示转化为操作入口 |
| **P1** | 优化 6：视图切换附加数字 | `runtime-events-client.tsx` | 小改动，大量减少无效切换 |
| **P2** | 优化 5：筛选器增强 | `runtime-events-client.tsx` | 提升搜索效率 |
| **P2** | 优化 7：分页增强 | `runtime-events-client.tsx` | 减少翻页次数 |

---

## 四、推荐实施方案（P0 部分）

### 方案 A：事件列表行级操作 + 轻量抽屉分层

核心思路：**事件列表表格增加行内 Picker + 快捷操作列，路由概览保留批量抽屉**

#### 修改 `runtime-events-client.tsx`

1. **事件列表 `columns` 改造**：
   - 把现有「关联页面/模块」按钮替换为行内 `ContextNodePicker` 组件
   - 增加「当前归属」列，如已绑定则显示 Page/Module 名称
   - 增加行级「忽略」和「保存」操作按钮
   - 每行操作直接调用 `upsertRuntimeSessionDraftOpAction`

2. **预加载 contextPages 数据**：
   - 在组件 mount 时就加载 `listRuntimeContextNodesQuery`，而不是等抽屉打开才加载
   - 确保行内 Picker 有可用的页面/模块数据

3. **保留路由概览中的抽屉入口**：路由概览的「查看/处理」仍然打开 `RuntimeSyncDrawer` 做批量操作

#### 修改 `runtime-sync-drawer.tsx`

1. **去除页面未创建时的强阻断遮罩**（L459-L469）
2. 改为：顶部保留创建页面的提示与表单，但下方 diff 表格**正常可交互**
3. 在 Picker 中，如果没有匹配的 Page，增加「快速创建本路由页面」inline 选项

---

## 五、验证计划

### 手动验证
由于这些改动主要是 UI 交互层面，建议在本地开发环境中验证：
1. 启动 `npm run dev`，进入 `/projects/[id]/runtime-sync/session`
2. 确保有活跃的采集会话和采集数据
3. 验证事件列表行级操作是否可用，是否能直接绑定/忽略
4. 验证路由概览抽屉是否仍正常工作
5. 验证新路由（无 Page）场景下，抽屉不再阻断查看，并可正常创建页面
